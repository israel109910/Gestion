{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Calculadora de Viáticos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts for modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: #fff;
            font-family: 'Montserrat', Arial, sans-serif;
            min-height: 100vh;
        }
        .main-title {
            color: #ff9800;
            font-weight: 700;
            letter-spacing: 1px;
        }
        .card {
            border-radius: 1.2rem;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.04);
            border: 1.5px solid #f3f3f3;
            background: #fff;
        }
        .card-title {
            color: #ff9800 !important;
            font-weight: 600;
        }
        .btn-primary {
            background: #ffb300;
            border: none;
            color: #fff;
            border-radius: 2rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px 0 rgba(255, 152, 0, 0.08);
        }
        .btn-primary:hover {
            background: #ff9800;
            color: #fff;
        }
        .btn-outline-secondary {
            color: #ff9800;
            border-color: #ff9800;
            background: #fff;
            border-radius: 2rem;
            font-weight: 600;
        }
        .btn-outline-secondary:hover {
            background: #ff9800;
            color: #fff;
        }
        .form-select, .form-control {
            border-radius: 1rem;
            border: 1.5px solid #e0e0e0;
            background: #fff;
        }
        .form-check-input:checked {
            background-color: #ff9800;
            border-color: #ff9800;
        }
        .viaje-form h5 {
            font-weight: 700;
            color: #ff9800;
        }
        .result-card {
            border-left: 6px solid #ff9800;
            border-radius: 1.2rem;
            background: #fff;
        }
        details summary {
            cursor: pointer;
            color: #ff9800;
            font-weight: 600;
        }
        details[open] summary {
            color: #f57c00;
        }
        .text-success {
            color: #388e3c !important;
        }
        .badge-yellow {
            background: #ffe082;
            color: #ff9800;
            font-weight: 600;
            border-radius: 0.7rem;
            padding: 0.3em 0.8em;
        }
        /* Neutrals for table and form */
        .form-label, .form-check-label, .form-control, .form-select {
            color: #333;
        }
        .mb-2.main-title {
            margin-bottom: 0.5rem !important;
        }
        /* Only highlight key numbers and actions */
        .highlight {
            color: #ff9800;
            font-weight: 700;
        }
    </style>
</head>
<body>
<div class="container py-4">
    <div class="text-center mb-5">
        <h2 class="main-title mb-2">Calculadora de Viáticos</h2>
        <span class="badge badge-yellow fs-6">Corporativo</span>
    </div>

    <div id="formularios-container">
        <div class="viaje-form card p-4 mb-4">
            <h5>Viaje 1</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Estado:</label>
                    <select class="form-select estado" required>
                        <option value="">Selecciona un estado</option>
                        {% for estado in estados %}
                            <option value="{{ estado.id }}">{{ estado.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Sección:</label>
                    <select class="form-select seccion" required>
                        <option value="">Selecciona una sección</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Sitio:</label>
                    <select class="form-select sitio" required>
                        <option value="">Selecciona un sitio</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Personas:</label>
                    <input type="number" class="form-control personas" required min="1" max="5" placeholder="Ej: 2">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Días:</label>
                    <input type="number" class="form-control dias" required min="1" placeholder="Ej: 1">
                </div>
                <div class="col-md-4 align-self-end">
                    <div class="form-check mt-3">
                        <input type="checkbox" class="form-check-input herramientas" id="herramientas1">
                        <label class="form-check-label" for="herramientas1">¿Lleva herramienta?</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="d-grid mb-3">
        <button class="btn btn-outline-secondary" onclick="agregarFormulario()">
            <i class="bi bi-plus-circle"></i> Agregar otro viaje
        </button>
    </div>

    <form method="post" id="formulario-principal">
        {% csrf_token %}
        <input type="hidden" name="viajes_json" id="viajes_json">
        <div class="d-grid">
            <button type="submit" class="btn btn-primary btn-lg shadow">Calcular Todos</button>
        </div>
    </form>
</div>

{% if resultado %}
<div class="container mt-4">
    <h3 class="text-success mb-4">Resultados</h3>
    {% for r in resultado %}
    <div class="card mb-4 p-3 result-card shadow">
        <div class="card-body">
            <h5 class="card-title mb-2">Resultado del viaje a <span class="highlight">{{ r.sitio }}</span></h5>
            <p><strong>¿Requiere TAG?:</strong> <span class="highlight">{{ r.requiere_tag|yesno:"Sí,No" }}</span></p>
            {% if r.costo_peaje > 0 %}
                <p><strong>Costo de Peaje:</strong> <span class="badge badge-yellow">${{ r.costo_peaje|floatformat:2 }}</span></p>
            {% endif %}
            <hr>
            <h6 class="mb-2">Desglose de costos</h6>
            <ul class="list-unstyled mb-2">
                <li><strong>Gasolina:</strong> <span class="badge badge-yellow">${{ r.costo_gasolina|floatformat:2 }}</span></li>
                <li><strong>Peajes:</strong> <span class="badge badge-yellow">${{ r.costo_peaje|floatformat:2 }}</span></li>
                <li><strong>Total estimado:</strong> <span class="highlight fs-5">${{ r.costo_total|floatformat:2 }}</span></li>
            </ul>
            <details class="mt-3">
                <summary class="text-muted">Ver detalle del cálculo</summary>
                <ul class="mt-2">
                    <li><strong>Personas:</strong> {{ r.detalle.personas }}</li>
                    <li><strong>Días:</strong> {{ r.detalle.dias }}</li>
                    <li><strong>¿Lleva herramienta?:</strong> {{ r.detalle.herramientas|yesno:"Sí,No" }}</li>
                    <li><strong>Distancia (ida y vuelta):</strong> {{ r.detalle.distancia_km }} km</li>
                    <li><strong>Peso por persona:</strong> {{ r.detalle.peso_prom_persona }} kg</li>
                    {% if r.detalle.herramientas %}
                        <li><strong>Peso herramienta:</strong> {{ r.detalle.peso_herramienta }} kg</li>
                    {% endif %}
                    <li><strong>Peso total:</strong> {{ r.detalle.peso_total }} kg</li>
                    <li><strong>Peso relativo:</strong> {{ r.detalle.peso_relativo }}</li>
                    <li><strong>Rendimiento base:</strong> {{ r.detalle.rendimiento_base }} km/l</li>
                    <li><strong>Rendimiento ajustado:</strong> {{ r.detalle.rendimiento_ajustado }} km/l</li>
                    <li><strong>Precio gasolina:</strong> ${{ r.detalle.precio_gasolina }}</li>
                    <li><strong>Fórmula:</strong> {{ r.detalle.formula }}</li>
                    <li><strong>Cálculo rendimiento:</strong> {{ r.detalle.explicacion_rendimiento }}</li>
                </ul>
            </details>
        </div>
    </div>
    {% endfor %}
     <div class="alert alert-success text-end fs-5 fw-bold mt-4">
        Total acumulado de todos los viajes: <span class="highlight">${{ total_general|floatformat:2 }}</span>
    </div>
</div>
{% endif %}

<!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<script>
    const secciones = {{ secciones_json|safe }};
    const sitios = {{ sitios_json|safe }};
    let contador = 1;

    function actualizarEventos() {
        document.querySelectorAll('.estado').forEach(select => {
            select.onchange = function () {
                const estadoId = this.value;
                const seccionSelect = this.closest('.viaje-form').querySelector('.seccion');
                seccionSelect.innerHTML = '<option value="">Selecciona una sección</option>';
                Object.entries(secciones).forEach(([id, seccion]) => {
                    if (seccion.estado_id == estadoId) {
                        seccionSelect.innerHTML += `<option value="${id}">${seccion.nombre}</option>`;
                    }
                });
                this.closest('.viaje-form').querySelector('.sitio').innerHTML = '<option value="">Selecciona un sitio</option>';
            };
        });

        document.querySelectorAll('.seccion').forEach(select => {
            select.onchange = function () {
                const seccionId = this.value;
                const sitioSelect = this.closest('.viaje-form').querySelector('.sitio');
                sitioSelect.innerHTML = '<option value="">Selecciona un sitio</option>';
                Object.entries(sitios).forEach(([id, sitio]) => {
                    if (sitio.seccion_id == seccionId) {
                        sitioSelect.innerHTML += `<option value="${id}">${sitio.nombre}</option>`;
                    }
                });
            };
        });
    }

    function agregarFormulario() {
        contador++;
        const contenedor = document.getElementById('formularios-container');
        const plantilla = document.querySelector('.viaje-form');
        const nueva = plantilla.cloneNode(true);
        nueva.querySelector('h5').innerText = `Viaje ${contador}`;
        nueva.querySelectorAll('select, input').forEach(input => {
            if (input.type === 'checkbox') input.checked = false;
            else input.value = '';
        });
        // Cambia el id del checkbox para accesibilidad
        const checkbox = nueva.querySelector('.herramientas');
        const label = nueva.querySelector('.form-check-label');
        const newId = 'herramientas' + contador;
        checkbox.id = newId;
        label.setAttribute('for', newId);

        contenedor.appendChild(nueva);
        actualizarEventos();
    }

    actualizarEventos();

    document.getElementById('formulario-principal').addEventListener('submit', function (e) {
        e.preventDefault();
        const viajes = [];
        let valid = true;
        document.querySelectorAll('.viaje-form').forEach(form => {
            const sitio = form.querySelector('.sitio').value;
            const personas = form.querySelector('.personas').value;
            const dias = form.querySelector('.dias').value;
            const herramientas = form.querySelector('.herramientas').checked;

            if (!sitio || !personas || !dias) {
                valid = false;
            }

            viajes.push({ sitio, personas, dias, herramientas });
        });

        if (!valid) {
            alert("Por favor completa todos los campos obligatorios.");
            return;
        }

        document.getElementById('viajes_json').value = JSON.stringify(viajes);
        this.submit();
    });
</script>
</body>
</html>
