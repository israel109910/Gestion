{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Calculadora de Viáticos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #f8f9fa;
        }
        .form-container {
            max-width: 900px;
            margin: 40px auto;
        }
    </style>
</head>
<body>
<div class="container form-container p-4 border rounded shadow bg-white">
    <h2 class="mb-4 text-primary">Cálculo de Viáticos</h2>

    <!-- Contenedor dinámico de formularios -->
    <div id="formularios-container">
        <div class="viaje-form card p-3 mb-3 shadow-sm border position-relative">
            <h5 class="text-primary">Viaje 1</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <label>Estado:</label>
                    <select class="form-select estado" required>
                        <option value="">Selecciona un estado</option>
                        {% for estado in estados %}
                            <option value="{{ estado.id }}">{{ estado.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label>Sección:</label>
                    <select class="form-select seccion" required>
                        <option value="">Selecciona una sección</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label>Sitio:</label>
                    <select class="form-select sitio" required>
                        <option value="">Selecciona un sitio</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label>Personas:</label>
                    <input type="number" class="form-control personas" required min="1" max="5">
                </div>
                <div class="col-md-4">
                    <label>Días:</label>
                    <input type="number" class="form-control dias" required min="1">
                </div>
                <div class="col-md-4 align-self-end">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input herramientas">
                        <label class="form-check-label">¿Lleva herramienta?</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botón para agregar nuevo formulario -->
    <div class="d-grid mb-4">
        <button type="button" class="btn btn-outline-secondary" onclick="agregarFormulario()">Agregar otro viaje</button>
    </div>

    <!-- Formulario principal para enviar todo -->
    <form method="post" id="formulario-principal">
        {% csrf_token %}
        <input type="hidden" name="viajes_json" id="viajes_json">
        <div class="d-grid">
            <button type="submit" class="btn btn-primary">Calcular Todos</button>
        </div>
    </form>
</div>

{% if resultado %}
<div class="container mt-4">
    <h3 class="text-success">Resultados</h3>
    {% for r in resultado %}
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Resultado del viaje a {{ r.sitio }}</h5>
                <p><strong>¿Requiere TAG?:</strong> {{ r.requiere_tag|yesno:"Sí,No" }}</p>

                {% if r.costo_peaje > 0 %}
                    <p><strong>Costo de Peaje:</strong> ${{ r.costo_peaje|floatformat:2 }}</p>
                {% endif %}

                <hr>
                <h6>Desglose de costos</h6>
                <ul class="list-unstyled">
                    <li><strong>Gasolina:</strong> ${{ r.costo_gasolina|floatformat:2 }}</li>
                    <li><strong>Peajes:</strong> ${{ r.costo_peaje|floatformat:2 }}</li>
                    <li><strong>Total estimado:</strong> <span class="text-success">${{ r.costo_total|floatformat:2 }}</span></li>
                </ul>

                <details class="mt-3">
                    <summary class="text-muted">Ver detalle del cálculo</summary>
                    <ul class="mt-2">
                        <li><strong>Personas:</strong> {{ r.detalle.personas }}</li>
                        <li><strong>Días:</strong> {{ r.detalle.dias }}</li>
                        <li><strong>¿Lleva herramienta?:</strong> {{ r.detalle.herramientas|yesno:"Sí,No" }}</li>
                        <li><strong>Peso total:</strong> {{ r.detalle.peso_total }} kg</li>
                        <li><strong>Rendimiento ajustado:</strong> {{ r.detalle.rendimiento_ajustado }} km/l</li>
                        <li><strong>Fórmula usada:</strong> {{ r.detalle.formula }}</li>
                    </ul>
                </details>
            </div>
        </div>
    {% endfor %}
</div>
{% endif %}

<!-- Scripts -->
<script>
    const secciones = {{ secciones_json|safe }};
    const sitios = {{ sitios_json|safe }};
    let contador = 1;

    function actualizarEventos() {
        document.querySelectorAll('.estado').forEach(select => {
            select.onchange = function () {
                const estadoId = this.value;
                const seccionSelect = this.closest('.viaje-form').querySelector('.seccion');
                seccionSelect.innerHTML = '<option value="">Selecciona una sección</option>';
                Object.entries(secciones).forEach(([id, seccion]) => {
                    if (seccion.estado_id == estadoId) {
                        seccionSelect.innerHTML += `<option value="${id}">${seccion.nombre}</option>`;
                    }
                });
                this.closest('.viaje-form').querySelector('.sitio').innerHTML = '<option value="">Selecciona un sitio</option>';
            };
        });

        document.querySelectorAll('.seccion').forEach(select => {
            select.onchange = function () {
                const seccionId = this.value;
                const sitioSelect = this.closest('.viaje-form').querySelector('.sitio');
                sitioSelect.innerHTML = '<option value="">Selecciona un sitio</option>';
                Object.entries(sitios).forEach(([id, sitio]) => {
                    if (sitio.seccion_id == seccionId) {
                        sitioSelect.innerHTML += `<option value="${id}">${sitio.nombre}</option>`;
                    }
                });
            };
        });
    }

    function agregarFormulario() {
        contador++;
        const contenedor = document.getElementById('formularios-container');
        const plantilla = document.querySelector('.viaje-form');
        const nueva = plantilla.cloneNode(true);
        nueva.querySelector('h5').innerText = `Viaje ${contador}`;
        nueva.querySelectorAll('select, input').forEach(input => {
            if (input.type === 'checkbox') input.checked = false;
            else input.value = '';
        });
        contenedor.appendChild(nueva);
        actualizarEventos();
    }

    actualizarEventos();

    // Captura y envía los formularios como JSON
    document.getElementById('formulario-principal').addEventListener('submit', function (e) {
        e.preventDefault();
        const viajes = [];
        let valid = true;
        document.querySelectorAll('.viaje-form').forEach(form => {
            const sitio = form.querySelector('.sitio').value;
            const personas = form.querySelector('.personas').value;
            const dias = form.querySelector('.dias').value;
            const herramientas = form.querySelector('.herramientas').checked;

            if (!sitio || !personas || !dias) {
                valid = false;
            }

            viajes.push({ sitio, personas, dias, herramientas });
        });

        if (!valid) {
            alert("Por favor completa todos los campos obligatorios.");
            return;
        }

        document.getElementById('viajes_json').value = JSON.stringify(viajes);
        this.submit();
    });
</script>
</body>
</html>
